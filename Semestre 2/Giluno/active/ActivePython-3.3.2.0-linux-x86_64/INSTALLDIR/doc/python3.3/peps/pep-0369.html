<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<!--
This HTML is auto-generated.  DO NOT EDIT THIS FILE!  If you are writing a new
PEP, see http://www.python.org/peps/pep-0001.html for instructions and links
to templates.  DO NOT USE THIS HTML FILE AS YOUR TEMPLATE!
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
  <title>PEP 369 -- Post import hooks</title>
  <link rel="stylesheet" href="pep.css" type="text/css" /></head>
<body bgcolor="white">
<table class="rfc2822 docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">PEP:</th><td class="field-body">369</td>
</tr>
<tr class="field"><th class="field-name">Title:</th><td class="field-body">Post import hooks</td>
</tr>
<tr class="field"><th class="field-name">Version:</th><td class="field-body">63925</td>
</tr>
<tr class="field"><th class="field-name">Last-Modified:</th><td class="field-body"><a class="reference external" href="http://svn.python.org/view/*checkout*/peps/trunk/pep-0369.txt">2008-06-03 08:18:48 -0700 (Tue, 03 Jun 2008)</a></td>
</tr>
<tr class="field"><th class="field-name">Author:</th><td class="field-body">Christian Heimes &lt;christian(at)cheimes(dot)de&gt;</td>
</tr>
<tr class="field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field"><th class="field-name">Type:</th><td class="field-body">Standards Track</td>
</tr>
<tr class="field"><th class="field-name">Content-Type:</th><td class="field-body"><a class="reference external" href="/dev/peps/pep-0012">text/x-rst</a></td>
</tr>
<tr class="field"><th class="field-name">Created:</th><td class="field-body">02-Jan-2008</td>
</tr>
<tr class="field"><th class="field-name">Python-Version:</th><td class="field-body">2.6, 3.0</td>
</tr>
<tr class="field"><th class="field-name">Post-History:</th><td class="field-body"></td>
</tr>
</tbody>
</table>
<hr />
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#abstract" id="id9">Abstract</a></li>
<li><a class="reference internal" href="#rationale" id="id10">Rationale</a></li>
<li><a class="reference internal" href="#use-cases" id="id11">Use cases</a></li>
<li><a class="reference internal" href="#existing-implementations" id="id12">Existing implementations</a></li>
<li><a class="reference internal" href="#post-import-hook-implementation" id="id13">Post import hook implementation</a><ul>
<li><a class="reference internal" href="#states" id="id14">States</a><ul>
<li><a class="reference internal" href="#no-hook-was-registered" id="id15">No hook was registered</a></li>
<li><a class="reference internal" href="#a-hook-is-registered-and-the-module-is-not-loaded-yet" id="id16">A hook is registered and the module is not loaded yet</a></li>
<li><a class="reference internal" href="#a-module-is-successfully-loaded" id="id17">A module is successfully loaded</a></li>
<li><a class="reference internal" href="#a-module-can-t-be-loaded" id="id18">A module can't be loaded</a></li>
<li><a class="reference internal" href="#a-hook-is-registered-but-the-module-is-already-loaded" id="id19">A hook is registered but the module is already loaded</a></li>
</ul>
</li>
<li><a class="reference internal" href="#invariants" id="id20">Invariants</a></li>
<li><a class="reference internal" href="#sample-python-implementation" id="id21">Sample Python implementation</a></li>
<li><a class="reference internal" href="#c-api" id="id22">C API</a><ul>
<li><a class="reference internal" href="#new-c-api-functions" id="id23">New C API functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#python-api" id="id24">Python API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#open-issues" id="id25">Open issues</a></li>
<li><a class="reference internal" href="#backwards-compatibility" id="id26">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#reference-implementation" id="id27">Reference Implementation</a></li>
<li><a class="reference internal" href="#acknowledgments" id="id28">Acknowledgments</a></li>
<li><a class="reference internal" href="#copyright" id="id29">Copyright</a></li>
<li><a class="reference internal" href="#references" id="id30">References</a></li>
</ul>
</div>
<div class="section" id="abstract">
<h1><a class="toc-backref" href="#id9">Abstract</a></h1>
<p>This PEP proposes enhancements for the import machinery to add
post import hooks. It is intended primarily to support the wider
use of abstract base classes that is expected in Python 3.0.</p>
<p>The PEP originally started as a combined PEP for lazy imports and
post import hooks. After some discussion on the python-dev mailing
list the PEP was parted in two separate PEPs. <a class="footnote-reference" href="#id5" id="id1">[1]</a></p>
</div>
<div class="section" id="rationale">
<h1><a class="toc-backref" href="#id10">Rationale</a></h1>
<p>Python has no API to hook into the import machinery and execute code
<em>after</em> a module is successfully loaded. The import hooks of <a class="reference external" href="/dev/peps/pep-0302">PEP 302</a> are
about finding modules and loading modules but they were not designed to
as post import hooks.</p>
</div>
<div class="section" id="use-cases">
<h1><a class="toc-backref" href="#id11">Use cases</a></h1>
<p>A use case for a post import hook is mentioned in Nick Coghlan's initial
posting <a class="footnote-reference" href="#id6" id="id2">[2]</a>. about callbacks on module import. It was found during the
development of Python 3.0 and its ABCs. We wanted to register classes
like decimal.Decimal with an ABC but the module should not be imported
on every interpreter startup. Nick came up with this example:</p>
<pre class="literal-block">
&#64;imp.when_imported('decimal')
def register(decimal):
    Inexact.register(decimal.Decimal)
</pre>
<p>The function <tt class="docutils literal"><span class="pre">register</span></tt> is registered as callback for the module named
'decimal'. When decimal is imported the function is called with the
module object as argument.</p>
<p>While this particular example isn't necessary in practice, (as
decimal.Decimal will inherit from the appropriate abstract Number base
class in 2.6 and 3.0), it still illustrates the principle.</p>
</div>
<div class="section" id="existing-implementations">
<h1><a class="toc-backref" href="#id12">Existing implementations</a></h1>
<p>PJE's peak.util.imports <a class="footnote-reference" href="#id7" id="id3">[3]</a> implements post load hooks. My
implementation shares a lot with his and it's partly based on his ideas.</p>
</div>
<div class="section" id="post-import-hook-implementation">
<h1><a class="toc-backref" href="#id13">Post import hook implementation</a></h1>
<p>Post import hooks are called after a module has been loaded. The hooks
are callable which take one argument, the module instance. They are
registered by the dotted name of the module, e.g. 'os' or 'os.path'.</p>
<p>The callable are stored in the dict <tt class="docutils literal"><span class="pre">sys.post_import_hooks</span></tt> which
is a mapping from names (as string) to a list of callables or None.</p>
<div class="section" id="states">
<h2><a class="toc-backref" href="#id14">States</a></h2>
<div class="section" id="no-hook-was-registered">
<h3><a class="toc-backref" href="#id15">No hook was registered</a></h3>
<p>sys.post_import_hooks contains no entry for the module</p>
</div>
<div class="section" id="a-hook-is-registered-and-the-module-is-not-loaded-yet">
<h3><a class="toc-backref" href="#id16">A hook is registered and the module is not loaded yet</a></h3>
<p>The import hook registry contains an entry
sys.post_import_hooks[&quot;name&quot;] = [hook1]</p>
</div>
<div class="section" id="a-module-is-successfully-loaded">
<h3><a class="toc-backref" href="#id17">A module is successfully loaded</a></h3>
<p>The import machinery checks if sys.post_import_hooks contains post import
hooks for the newly loaded module. If hooks are found then the hooks are
called in the order they were registered with the module instance as first
argument. The processing of the hooks is stopped when a method raises an
exception. At the end the entry for the module name set to None, even
when an error has occured.</p>
<p>Additionally the new <tt class="docutils literal"><span class="pre">__notified__</span></tt> slot of the module object is set
to <tt class="docutils literal"><span class="pre">True</span></tt> in order to prevent infinity recursions when the notification
method is called inside a hook. For object which don't subclass from
<tt class="docutils literal"><span class="pre">PyModule</span></tt> a new attribute is added instead.</p>
</div>
<div class="section" id="a-module-can-t-be-loaded">
<h3><a class="toc-backref" href="#id18">A module can't be loaded</a></h3>
<p>The import hooks are neither called nor removed from the registry. It
may be possible to load the module later.</p>
</div>
<div class="section" id="a-hook-is-registered-but-the-module-is-already-loaded">
<h3><a class="toc-backref" href="#id19">A hook is registered but the module is already loaded</a></h3>
<p>The hook is fired immediately.</p>
</div>
</div>
<div class="section" id="invariants">
<h2><a class="toc-backref" href="#id20">Invariants</a></h2>
<p>The import hook system guarentees certain invariants. XXX</p>
</div>
<div class="section" id="sample-python-implementation">
<h2><a class="toc-backref" href="#id21">Sample Python implementation</a></h2>
<p>A Python implemenation may look like:</p>
<pre class="literal-block">
  def notify(name):
      try:
          module = sys.modules[name]
      except KeyError:
          raise ImportError(&quot;Module %s has not been imported&quot; % (name,))
      if module.__notified__:
          return
      try:
          module.__notified__ = True
          if '.' in name:
              notify(name[:name.rfind('.')])
          for callback in post_import_hooks[name]:
             callback(module)
      finally:
          post_import_hooks[name] = None

XXX
</pre>
</div>
<div class="section" id="c-api">
<h2><a class="toc-backref" href="#id22">C API</a></h2>
<div class="section" id="new-c-api-functions">
<h3><a class="toc-backref" href="#id23">New C API functions</a></h3>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">PyObject*</span> <span class="pre">PyImport_GetPostImportHooks(void)</span></tt></dt>
<dd>Returns the dict sys.post_import_hooks or NULL</dd>
<dt><tt class="docutils literal"><span class="pre">PyObject*</span> <span class="pre">PyImport_NotifyLoadedByModule(PyObject</span> <span class="pre">*module)</span></tt></dt>
<dd>Notify the post import system that a module was requested. Returns the
a borrowed reference to the same module object or NULL if an error has
occured. The function calls only the hooks for the module itself an not
its parents. The function must be called with the import lock acquired.</dd>
<dt><tt class="docutils literal"><span class="pre">PyObject*</span> <span class="pre">PyImport_NotifyLoadedByName(const</span> <span class="pre">char</span> <span class="pre">*name)</span></tt></dt>
<dd><tt class="docutils literal"><span class="pre">PyImport_NotifyLoadedByName(&quot;a.b.c&quot;)</span></tt> calls
<tt class="docutils literal"><span class="pre">PyImport_NotifyLoadedByModule()</span></tt> for <tt class="docutils literal"><span class="pre">a</span></tt>, <tt class="docutils literal"><span class="pre">a.b</span></tt> and <tt class="docutils literal"><span class="pre">a.b.c</span></tt>
in that particular order. The modules are retrieved from
<tt class="docutils literal"><span class="pre">sys.modules</span></tt>. If a module can't be retrieved, an exception is raised
otherwise the a borrowed reference to <tt class="docutils literal"><span class="pre">modname</span></tt> is returned.
The hook calls always start with the prime parent module.
The caller of PyImport_NotifyLoadedByName() must hold the import lock!</dd>
<dt><tt class="docutils literal"><span class="pre">PyObject*</span> <span class="pre">PyImport_RegisterPostImportHook(PyObject</span> <span class="pre">*callable,</span> <span class="pre">PyObject</span> <span class="pre">*mod_name)</span></tt></dt>
<dd>Register a new hook <tt class="docutils literal"><span class="pre">callable</span></tt> for the module <tt class="docutils literal"><span class="pre">mod_name</span></tt></dd>
<dt><tt class="docutils literal"><span class="pre">int</span> <span class="pre">PyModule_GetNotified(PyObject</span> <span class="pre">*module)</span></tt></dt>
<dd>Returns the status of the <tt class="docutils literal"><span class="pre">__notified__</span></tt> slot / attribute.</dd>
<dt><tt class="docutils literal"><span class="pre">int</span> <span class="pre">PyModule_SetNotified(PyObject</span> <span class="pre">*module,</span> <span class="pre">int</span> <span class="pre">status)</span></tt></dt>
<dd>Set the status of the <tt class="docutils literal"><span class="pre">__notified__</span></tt> slot / attribute.</dd>
</dl>
<p>The <tt class="docutils literal"><span class="pre">PyImport_NotifyLoadedByModule()</span></tt> method is called inside
<tt class="docutils literal"><span class="pre">import_submodule()</span></tt>. The import system makes sure that the import lock
is acquired and the hooks for the parent modules are already called.</p>
</div>
</div>
<div class="section" id="python-api">
<h2><a class="toc-backref" href="#id24">Python API</a></h2>
<p>The import hook registry and two new API methods are exposed through the
<tt class="docutils literal"><span class="pre">sys</span></tt> and <tt class="docutils literal"><span class="pre">imp</span></tt> module.</p>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">sys.post_import_hooks</span></tt></dt>
<dd><p class="first">The dict contains the post import hooks:</p>
<pre class="last literal-block">
{&quot;name&quot; : [hook1, hook2], ...}
</pre>
</dd>
<dt><tt class="docutils literal"><span class="pre">imp.register_post_import_hook(hook:</span> <span class="pre">&quot;callable&quot;,</span> <span class="pre">name:</span> <span class="pre">str)</span></tt></dt>
<dd>Register a new hook <em>hook</em> for the module <em>name</em></dd>
<dt><tt class="docutils literal"><span class="pre">imp.notify_module_loaded(module:</span> <span class="pre">&quot;module</span> <span class="pre">instance&quot;)</span> <span class="pre">-&gt;</span> <span class="pre">module</span></tt></dt>
<dd>Notify the system that a module has been loaded. The method is provided
for compatibility with existing lazy / deferred import extensions.</dd>
<dt><tt class="docutils literal"><span class="pre">module.__notified__</span></tt></dt>
<dd>A slot of a module instance. XXX</dd>
</dl>
<p>The when_imported function decorator is also in the imp module,
which is equivalent to:</p>
<pre class="literal-block">
def when_imported(name):
    def register(hook):
        register_post_import_hook(hook, name)
    return register
</pre>
<dl class="docutils">
<dt>imp.when_imported(name) -&gt; decorator function</dt>
<dd>for &#64;when_imported(name) def hook(module): pass</dd>
</dl>
</div>
</div>
<div class="section" id="open-issues">
<h1><a class="toc-backref" href="#id25">Open issues</a></h1>
<p>The when_imported decorator hasn't been written.</p>
<p>The code contains several XXX comments. They are mostly about error
handling in edge cases.</p>
</div>
<div class="section" id="backwards-compatibility">
<h1><a class="toc-backref" href="#id26">Backwards Compatibility</a></h1>
<p>The new features and API don't conflict with old import system of Python
and don't cause any backward compatibility issues for most software.
However systems like PEAK and Zope which implement their own lazy import
magic need to follow some rules.</p>
<p>The post import hooks carefully designed to cooperate with existing
deferred and lazy import systems. It's the suggestion of the PEP author
to replace own on-load-hooks with the new hook API. The alternative
lazy or deferred imports will still work but the implementations must
call the <tt class="docutils literal"><span class="pre">imp.notify_module_loaded</span></tt> function.</p>
</div>
<div class="section" id="reference-implementation">
<h1><a class="toc-backref" href="#id27">Reference Implementation</a></h1>
<p>A reference implementation is already written and is available in the
<em>py3k-importhook</em> branch. <a class="footnote-reference" href="#id8" id="id4">[4]</a> It still requires some cleanups,
documentation updates and additional unit tests.</p>
</div>
<div class="section" id="acknowledgments">
<h1><a class="toc-backref" href="#id28">Acknowledgments</a></h1>
<p>Nick Coghlan, for proof reading and the initial discussion
Phillip J. Eby, for his implementation in PEAK and help with my own implementation</p>
</div>
<div class="section" id="copyright">
<h1><a class="toc-backref" href="#id29">Copyright</a></h1>
<p>This document has been placed in the public domain.</p>
</div>
<div class="section" id="references">
<h1><a class="toc-backref" href="#id30">References</a></h1>
<table class="docutils footnote" frame="void" id="id5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>PEP: Lazy module imports and post import hook
<a class="reference external" href="http://permalink.gmane.org/gmane.comp.python.devel/90949">http://permalink.gmane.org/gmane.comp.python.devel/90949</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Interest in PEP for callbacks on module import
<a class="reference external" href="http://permalink.gmane.org/gmane.comp.python.python-3000.devel/11126">http://permalink.gmane.org/gmane.comp.python.python-3000.devel/11126</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>peak.utils.imports
<a class="reference external" href="http://svn.eby-sarna.com/Importing/peak/util/imports.py?view=markup">http://svn.eby-sarna.com/Importing/peak/util/imports.py?view=markup</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td>py3k-importhook branch
<a class="reference external" href="http://svn.python.org/view/python/branches/py3k-importhook/">http://svn.python.org/view/python/branches/py3k-importhook/</a></td></tr>
</tbody>
</table>
<!-- Local Variables:
mode: indented-text
indent-tabs-mode: nil
sentence-end-double-space: t
fill-column: 70
coding: utf-8
End: -->
</div>

</div>
<div class="footer">
<hr class="footer" />
<a class="reference external" href="pep-0369.txt">View document source</a>.
Generated on: 2013-09-17 06:14 UTC.
Generated by <a class="reference external" href="http://docutils.sourceforge.net/">Docutils</a> from <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> source.

</div>
</body>
</html>
