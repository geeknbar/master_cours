<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>


<link rel='start' href='../index.html' title='Python Documentation Index'>
<link rel="first" href="whatsnew23.html" title='What's New in Python 2.3'>
<link rel='contents' href='contents.html' title="Contents">
<link rel='last' href='about.html' title='About this document...'>
<link rel='help' href='about.html' title='About this document...'>
<LINK REL="next" HREF="node20.html">
<LINK REL="prev" HREF="node18.html">
<LINK REL="parent" HREF="whatsnew23.html">
<LINK REL="next" HREF="node20.html">
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name='aesop' content='information'>
<META NAME="description" CONTENT="Pymalloc: A Specialized Object Allocator">
<META NAME="keywords" CONTENT="whatsnew23">
<META NAME="resource-type" CONTENT="document">
<META NAME="distribution" CONTENT="global">
<title>18 Pymalloc: A Specialized Object Allocator</title>
<link rel="stylesheet" href="../style.css" type="text/css">
</head>
<body>
<DIV CLASS="navigation">
<table align="center" width="100%" cellpadding="0" cellspacing="2">
<tr>
<td><a rel="prev" title="17 New, Improved, and" 
  HREF="node18.html"><img src='../icons/previous.gif'
  border='0' height='32'  alt='Previous Page' width='32'></A></td>
<td><a rel="parent" title="What's New in Python" 
  HREF="whatsnew23.html"><img src='../icons/up.gif'
  border='0' height='32'  alt='Up One Level' width='32'></A></td>
<td><a rel="next" title="19 Build and C" 
  HREF="node20.html"><img src='../icons/next.gif'
  border='0' height='32'  alt='Next Page' width='32'></A></td>
<td align="center" width="100%">What's New in Python 2.3</td>
<td><a rel="contents" title="Table of Contents" 
  href="contents.html"><img src='../icons/contents.gif'
  border='0' height='32'  alt='Contents' width='32'></A></td>
<td><img src='../icons/blank.gif'
  border='0' height='32'  alt='' width='32'></td>
</tr></table>
<b class="navlabel">Previous:</b>
<a class="sectref" rel="prev" HREF="node18.html">17 New, Improved, and</A>
<b class="navlabel">Up:</b>
<a class="sectref" rel="parent" HREF="whatsnew23.html">What's New in Python</A>
<b class="navlabel">Next:</b>
<a class="sectref" rel="next" HREF="node20.html">19 Build and C</A>
<br><hr>
</DIV>
<!--End of Navigation Panel-->

<H1><A NAME="SECTION0001900000000000000000">&nbsp;</A>
<BR>
18 Pymalloc: A Specialized Object Allocator
</H1>

<P>
Pymalloc, a specialized object allocator written by Vladimir
Marangozov, was a feature added to Python 2.1.  Pymalloc is intended
to be faster than the system <tt class="cfunction">malloc()</tt> and to have less
memory overhead for allocation patterns typical of Python programs.
The allocator uses C's <tt class="cfunction">malloc()</tt> function to get large
pools of memory and then fulfills smaller memory requests from these
pools.

<P>
In 2.1 and 2.2, pymalloc was an experimental feature and wasn't
enabled by default; you had to explicitly enable it when compiling
Python by providing the
<b class="programopt">--with-pymalloc</b> option to the <b class="program">configure</b>
script.  In 2.3, pymalloc has had further enhancements and is now
enabled by default; you'll have to supply
<b class="programopt">--without-pymalloc</b> to disable it.

<P>
This change is transparent to code written in Python; however,
pymalloc may expose bugs in C extensions.  Authors of C extension
modules should test their code with pymalloc enabled,
because some incorrect code may cause core dumps at runtime.  

<P>
There's one particularly common error that causes problems.  There are
a number of memory allocation functions in Python's C API that have
previously just been aliases for the C library's <tt class="cfunction">malloc()</tt>
and <tt class="cfunction">free()</tt>, meaning that if you accidentally called
mismatched functions the error wouldn't be noticeable.  When the
object allocator is enabled, these functions aren't aliases of
<tt class="cfunction">malloc()</tt> and <tt class="cfunction">free()</tt> any more, and calling the
wrong function to free memory may get you a core dump.  For example,
if memory was allocated using <tt class="cfunction">PyObject_Malloc()</tt>, it has to
be freed using <tt class="cfunction">PyObject_Free()</tt>, not <tt class="cfunction">free()</tt>.  A
few modules included with Python fell afoul of this and had to be
fixed; doubtless there are more third-party modules that will have the
same problem.

<P>
As part of this change, the confusing multiple interfaces for
allocating memory have been consolidated down into two API families.
Memory allocated with one family must not be manipulated with
functions from the other family.  There is one family for allocating
chunks of memory and another family of functions specifically for
allocating Python objects.

<P>

<UL>
<LI>To allocate and free an undistinguished chunk of memory use
  the ``raw memory'' family: <tt class="cfunction">PyMem_Malloc()</tt>,
  <tt class="cfunction">PyMem_Realloc()</tt>, and <tt class="cfunction">PyMem_Free()</tt>.

<P>
</LI>
<LI>The ``object memory'' family is the interface to the pymalloc
  facility described above and is biased towards a large number of
  ``small'' allocations: <tt class="cfunction">PyObject_Malloc</tt>,
  <tt class="cfunction">PyObject_Realloc</tt>, and <tt class="cfunction">PyObject_Free</tt>.

<P>
</LI>
<LI>To allocate and free Python objects, use the ``object'' family
  <tt class="cfunction">PyObject_New()</tt>, <tt class="cfunction">PyObject_NewVar()</tt>, and
  <tt class="cfunction">PyObject_Del()</tt>.
</LI>
</UL>

<P>
Thanks to lots of work by Tim Peters, pymalloc in 2.3 also provides
debugging features to catch memory overwrites and doubled frees in
both extension modules and in the interpreter itself.  To enable this
support, compile a debugging version of the Python interpreter by
running <b class="program">configure</b> with <b class="programopt">--with-pydebug</b>.

<P>
To aid extension writers, a header file <span class="file">Misc/pymemcompat.h</span> is
distributed with the source to Python 2.3 that allows Python
extensions to use the 2.3 interfaces to memory allocation while
compiling against any version of Python since 1.5.2.  You would copy
the file from Python's source distribution and bundle it with the
source of your extension.

<P>
<div class="seealso">
  <p class="heading"><b>See Also:</b></p>

<P>
<dl compact class="seeurl">
    <dt><a href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/python/python/dist/src/Objects/obmalloc.c"
        class="url">http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/python/python/dist/src/Objects/obmalloc.c</a>
    <dd>For the full details of the pymalloc implementation, see
the comments at the top of the file <span class="file">Objects/obmalloc.c</span> in the
Python source code.  The above link points to the file within the
SourceForge CVS browser.
  </dl>

<P>
</div>

<P>

<DIV CLASS="navigation">
<p><hr>
<table align="center" width="100%" cellpadding="0" cellspacing="2">
<tr>
<td><a rel="prev" title="17 New, Improved, and" 
  rel="prev" title="17 New, Improved, and" 
  HREF="node18.html"><img src='../icons/previous.gif'
  border='0' height='32'  alt='Previous Page' width='32'></A></td>
<td><a rel="parent" title="What's New in Python" 
  rel="parent" title="What's New in Python" 
  HREF="whatsnew23.html"><img src='../icons/up.gif'
  border='0' height='32'  alt='Up One Level' width='32'></A></td>
<td><a rel="next" title="19 Build and C" 
  rel="next" title="19 Build and C" 
  HREF="node20.html"><img src='../icons/next.gif'
  border='0' height='32'  alt='Next Page' width='32'></A></td>
<td align="center" width="100%">What's New in Python 2.3</td>
<td><a rel="contents" title="Table of Contents" 
  rel="contents" title="Table of Contents" 
  href="contents.html"><img src='../icons/contents.gif'
  border='0' height='32'  alt='Contents' width='32'></A></td>
<td><img src='../icons/blank.gif'
  border='0' height='32'  alt='' width='32'></td>
</tr></table>
<b class="navlabel">Previous:</b>
<a class="sectref" rel="prev" HREF="node18.html">17 New, Improved, and</A>
<b class="navlabel">Up:</b>
<a class="sectref" rel="parent" HREF="whatsnew23.html">What's New in Python</A>
<b class="navlabel">Next:</b>
<a class="sectref" rel="next" HREF="node20.html">19 Build and C</A>
<hr>
<span class="release-info">Release 1.00.</span>
</DIV>
<!--End of Navigation Panel-->
<ADDRESS>
See <i><a href="about.html">About this document...</a></i> for information on suggesting changes.
</ADDRESS>
</BODY>
</HTML>
